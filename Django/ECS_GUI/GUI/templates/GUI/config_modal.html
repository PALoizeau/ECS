{% extends "GUI/modal_base.html" %}

{%block title%}Configuration{%endblock%}

{%block body%}
  <div class="container">
  <script>
    function systemSelectChange(selectBox){
       //change content of details popup
       $('#detailsConfig'+selectBox.attributes["systemId"].textContent).attr("data-content",selectBox.selectedOptions[0].attributes["details"].textContent)
       //change selected tag to custom
       $('#selTag').val("customTag")
    };
  </script>
  {%for system in view.systemConfigs.items%}
  <div class="row">
    <div class="col">
      {{system.0}}
    </div>
    <div class="col">
      <select class="form-control" id="selConf{{system.0}}" systemId="{{system.0}}" onchange="systemSelectChange(this)">
        {%for config in system.1.items%}
          <option id="config{{config.0}}" details="{%for k,v in config.1.items%} {{k}} = {{v}} <br/>{%endfor%}" value="{{config.0}}">{{config.0}}</option>
        {%endfor%}
      </select>
    </div>
    <div class="col">
      <a tabindex="0" id="detailsConfig{{system.0}}" class="btn btn-primary btn-sm" role="button" data-toggle="popover" data-trigger="focus" title="Details For {{system.0}}" data-html="true" data-content="dsad">Details</a>
      <script>
         //set data for details button
         var detailContent = $("#selConf{{system.0}} option:selected").attr("details")
         $('#detailsConfig{{system.0}}').attr("data-content",detailContent)
         $('[data-toggle="popover"]').popover()
      </script>
    </div>
  </div>
  {%endfor%}
  <div class="row">
    {%if view.error%}
      <p>Error getting TagList {{view.error}}</p>
    {%else%}
      <div class="form-group">
       <label for="selTag">Select Config Tag:</label>
       {%if view.tagList%}
         <select class="selectpicker form-control" id="selTag">
           <optgroup label="compatible config tags">
           {% if view.currentTag and not view.customTag %}
               <option>{{view.currentTag}}</option>
           {%endif%}
           {%for t in view.tagList%}
              <option>{{t}}</option>
           {%endfor%}
           </optgroup>
           <optgroup label="use custom tag">
             <option custom="True" {% if view.customTag or not view.currentTag%}selected{%endif%} value="customTag">custom tag</option>
           </optgroup>
         </select>
         <script>
            //load config Tag via Ajax request
            $("#selTag").change(function(event){
              var tag = event.target.selectedOptions[0].textContent;
              $.ajax({
                  type: "POST",
                  url: "{% url 'GUI:getConfigsForTag'%}",
                  data:{
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    tag: tag,
                  },
                  error: function(jqXHR, textStatus, errorThrown) {
                      console.log(jqXHR.status);
                  },
                  "success": function(result) {
                      for (config in result){
                          system = result[config][0];
                          $("#selConf"+system).val(config);
                          //$("#selConf"+system).change();
                      }
                  },
              });
            });
         </script>
       {%else%}
         <p>No Config Tags for this Detector Assignment</p>
       {%endif%}
      </div>
    {%endif%}
  </div>
  <div cass="form-row">
    <form id="configureSave_form">
        <input  id="configureTagSave_input" class="form-control" type="text" placeholder="Tagname" required>
        <div class="invalid-feedback">
          Please enter a Name
        </div>
        <button id="ready" class="btn btn-primary" onclick="saveConfig()">Save as new Configtag</button>
    </form>
    <script>
      function saveConfig(){
        form = $("#configureSave_form")[0];
        valid=form.checkValidity();
        if (valid){
          //TODO do something
        }
        else{
          form.classList.add('was-validated');
        }
      }
    </script>
  </div>
  </div>
{%endblock body%}

{%block footer%}
  <script>
    $('#select').click(function(event){
        //#selectedTag is on the monitoring page
        var selectedTag = $("#selTag").find(":selected");
        if (selectedTag.attr("custom")){
          customConfiguration = [];
          confSelects = $("select[id^='selConf']")
          $.each( confSelects, function( key, sel ) {
            customConfiguration.push(sel.selectedOptions[0].attributes["value"].textContent);
          });
          $('#selectedTag').html(selectedTag.val());
          $('#configuration-modal').modal('toggle');
        }
        else{
          customConfiguration = false;
          $('#selectedTag').html(selectedTag.val());
          $('#configuration-modal').modal('toggle');
        }
    });
  </script>
  <button type="button" id="select" class="btn btn-primary">Select</button>
  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
{%endblock footer%}

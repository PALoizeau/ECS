<html>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>

    unmappedDetectorsHTML = ""
    {% for d in view.unmappedDetectors %}
    unmappedDetectorsHTML += "<a>Detector "+{{d.id}}+" </a><input type='checkbox' name='selectedDetectors' value='"+{{d.id}}+"'><br/>";
    {% endfor %}

    function changeDetectorList(pcaId){
      //set the DetectorList for the currently selected Parttion
      $("#detectors").empty()
      if (pcaId == "unmapped"){
        detDiv = document.getElementById("detectors");
        detDiv.innerHTML = unmappedDetectorsHTML
        return
      }
      $.ajax({
          type: "POST",
          url: "{% url 'GUI:getDetectorListForPCA'%}",
          data:{csrfmiddlewaretoken: '{{ csrf_token }}','pcaId' : pcaId},
          "success": function(result) {
              idArr = Object.keys(result);
              detDiv = document.getElementById("detectors");
              for (i in idArr){
                 str = "<a>Detector "+idArr[i]+" </a><input type='checkbox' name='selectedDetectors' value='"+idArr[i]+"'><br/>";
                 detDiv.innerHTML += str;
              }
          },
      });
    }
    var oldFrom = ""
    var oldTo = ""

    function check(dropdown){
      $("#message").html("")
      //Switch selected Values in Dropdowns if they are identical
      {% with view.partitions|length as l %}
          {% if l > 1 %}
          id = dropdown.id
          if (id == "toPartition"){
            otherId="fromPartition"
            old = oldTo
            oldTo = $("#"+id).val()
            changeDetectors = true
          }
          else{
            otherId="toPartition"
            old = oldFrom
            oldFrom = $("#"+id).val()
            changeDetectors = false
          }
          if (dropdown.value == $("#"+otherId).val()){
              //switch places
              console.log(dropdown.value)
              console.log(old)
              $("#"+otherId).val(old)
              if (otherId == "toPartition"){
                  oldTo = old
              }
              else {
                  oldFrom = old
              }
              if(changeDetectors)
                  changeDetectorList($("#"+otherId).val())
          }
          {%else%}
            $("#message").html("there is only one Partition");
          {% endif %}
      {% endwith %}
      return true
    }
    $(document).ready(function() {
      //set to-Dropdown to second entry
      $("#toPartition").val($("#toPartition option")[1].value)
      oldFrom = $("#fromPartition").val()
      oldTo = $("#toPartition").val()
      check(document.getElementById("toPartition"))
      changeDetectorList($("#fromPartition").val())
    });
  </script>
  <body>
    {%if view.errorMessage%}
    <a>{{view.errorMessage}}</a>
    {%endif%}
    <form action="{% url 'GUI:move_detectors' %}" method="post">
      {% csrf_token %}
      <div>
        <label>From Partition</label>
        <select id="fromPartition" name="fromPartition" onchange="check(this);changeDetectorList(this.value)">
          <option value="unmapped">unused Detectors</option>
          {% for p in view.partitions %}
            <option value="{{p.1.id}}">{{p.1.id}}</option>
          {% endfor %}
        </select>
      </div>
      <br/>
      <div id ="detectors">
      </div>
      <br/>
      <div>
        <label>To Partition</label>
        <select id="toPartition" name="toPartition" onchange="check(this)">
          <option value="unmapped">unused Detectors</option>
          {% for p in view.partitions %}
            <option value="{{p.1.id}}">{{p.1.id}}</option>
          {% endfor %}
        </select>
      </div>
      <br/>
      <input type="submit" value="move">
    </form>

  </body>
</html>

<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
console.log('ws://'+ window.location.host + '/ws/');
var updateSocket = new WebSocket('ws://'+ window.location.host + '/ws/');
//todo autoreconnect

updateSocket.onmessage = function(e) {
    var data = JSON.parse(e.data);
    var message = data['message'];
    var type = data['type'];

    if (type == "state"){
      var update = JSON.parse(message);
      var id = update['id'];
      var newState = update['state'];
      buttonHtml = "";
      if (newState == "inactive")
        buttonHtml = '<button id="activeToggle" onclick="setactive('+ update['id'] +')" > activate  </button>';
      else
        buttonHtml = '<button id="activeToggle" onclick="setinactive('+ update['id'] +')" > deactivate  </button>';
      $('#dState'+id).html(newState+buttonHtml);
    }
    else if (type == "log"){
      $('#log').append(message+"\n");
      //allways scroll directly to bottom
      var textarea = document.getElementById('log');
      textarea.scrollTop = textarea.scrollHeight;
    }

};

function setactive(id){
  $.ajax({
      type: "POST",
      url: "{% url 'GUI:setActive' pcaId%}",
      data:{csrfmiddlewaretoken: '{{ csrf_token }}', "detectorId" : id},
      "success": function(result) {
          console.log(result);
      },
  });
}

function setinactive(id){
  $.ajax({
      type: "POST",
      url: "{% url 'GUI:setInactive' pcaId%}",
      data:{csrfmiddlewaretoken: '{{ csrf_token }}', "detectorId" : id},
      "success": function(result) {
          console.log(result);
      },
  });
}

$(document).ready(function() {
    $("#ready").click(function(e) {
        e.preventDefault();
        $.ajax({
            type: "POST",
            url: "{% url 'GUI:ready' pcaId%}",
            data:{csrfmiddlewaretoken: '{{ csrf_token }}'},
            /*"success": function(result) {
                console.log(result);
            },*/
        });
    });
    $("#start").click(function(e) {
        e.preventDefault();
        $.ajax({
            type: "POST",
            url: "{% url 'GUI:start' pcaId%}",
            data:{csrfmiddlewaretoken: '{{ csrf_token }}'},
        });
    });
    $("#stop").click(function(e) {
        e.preventDefault();
        $.ajax({
            type: "POST",
            url: "{% url 'GUI:stop' pcaId%}",
            data:{csrfmiddlewaretoken: '{{ csrf_token }}'},
        });
    });
    $("#shutdown").click(function(e) {
        e.preventDefault();
        $.ajax({
            type: "POST",
            url: "{% url 'GUI:shutdown' pcaId%}",
            data:{csrfmiddlewaretoken: '{{ csrf_token }}'},
        });
    });
});
</script>
</head>

<body>

<h1>PCA{{pcaID}} Overview</h1>

<div id="stateTable">
  <table>
    <tr>
      <th>Detector</th>
      <th>Status</th>
    </tr>
    {% for state in stateMap.items %}
    <tr>
        <td>
          {% if state.0 == 0%}
            Global State
          {%else%}
            {{state.0}}
          {% endif %}
        </td>
        <td id="dState{{state.0}}" >
          {{state.1.1}}
          {%if state.1.1 == "inactive" %}
            <button id="activeToggle" onclick="setactive({{state.0}})" > activate  </button>
          {% else %}
            <button id="activeToggle" onclick="setinactive({{state.0}})" > deactivate  </button>
          {% endif %}
        </td>
    </tr>
    {% endfor %}
  </table>
</div>
<div visibility:{{PCAConnection}}>
  <button id="ready">ready</button>
  <button id="start">start</button>
  <button id="stop">stop</button>
  <button id="shutdown">shutdown</button>
</div>
<textarea readonly id="log"></textarea>
{%if error%}
<p visibility:={{error}}>Error</p>
{%endif%}
</body>
</html>

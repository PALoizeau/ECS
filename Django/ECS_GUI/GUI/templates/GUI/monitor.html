<!DOCTYPE html>
<html>
<head>
{%block control%}
{% load guardian_tags %}
{% get_obj_perms request.user for view.pcaObject as "pcaPerms" %}
{% get_obj_perms request.user for view.ecsObject as "ecsPerms" %}
<meta http-equiv=”Pragma” content=”no-cache”>
<meta http-equiv=”Expires” content=”-1″>
<meta http-equiv=”CACHE-CONTROL” content=”NO-CACHE”>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
{% load static %}
<!-- Bootstrap core CSS-->
<link rel="stylesheet" type="text/css" href="{% static 'GUI/vendor/bootstrap/css/bootstrap.min.css' %}">
<!-- Page level plugin CSS-->
<link rel="stylesheet" type="text/css" href="{% static 'GUI/vendor/fontawesome-free/css/all.min.css' %}">
<!-- Custom styles for this template-->
<link href="{% static 'GUI/sb-admin.css' %}" rel="stylesheet">
<link href="{% static 'GUI/ecs.css' %}" rel="stylesheet">
<script>
function createWebSocket(){
    var updateSocket = new WebSocket('ws://'+ window.location.host + '/ws/{{pcaId}}/');

    function updateState(id,newState,sequenceNumber){
      if (newState == "Running" || newState == "Ready")
        var cssClass = newState
      else
        var cssClass = "NotReady"
      stateCircle = '<i class="fas fa-circle '+cssClass+'"></i>'
      var buttonHtml = "";
      {% if "has_control" in pcaPerms %}
      if (id == "{{view.pcaId}}")
        buttonHtml = ""
      else if (newState == "inactive")
        buttonHtml = '<button id="activeToggle" class="btn btn-primary activeButton" onclick="setactive('+ id +')" > activate  </button>';
      else
        buttonHtml = '<button id="activeToggle" class="btn btn-primary activeButton" onclick="setinactive('+ id +')" > deactivate  </button>';
      {% endif %}
      var stateObject = $('#dState'+id)
      //check if state already exists
      if(stateObject.length){
          if(parseInt(stateObject.attr("sequencenumber")) < sequenceNumber)
            stateObject.attr("sequencenumber",sequenceNumber)
            stateObject.html(stateCircle+newState+buttonHtml);
      }
      else{
          newRow = '<tr class="tableRow"> <td class="col-md-3">'+id+'</td><td id="dState'+id+'" sequencenumber="'+sequenceNumber+'">'+stateCircle+newState+buttonHtml+'</td></tr>'
          $("#stateTable").append(newRow)
      }
    }

    updateSocket.onopen = function(e){
      console.log("socket open")
      $(".tableRow").remove()
      //get stateTables
      updateSocket.send("{{pcaId}}")
    }

    updateSocket.onclose = function(e){
       setTimeout(function(){
      		console.log("trying to reconnect Websocket");
      		createWebSocket()
  	   },2000);
    }

    updateSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var message = data['message'];
        var type = data['type'];

        if (type == "state"){
          var update = JSON.parse(message);
          var id = update['id'];
          var newState = update['state'];
          var sequenceNumber = update['sequence']
          if(newState == "reset"){
              //clear Table
              $(".tableRow").remove()
          }
          else if (newState == "remove"){
              //delete Row
              $('#dRow'+id).remove()
          }
          else{
            updateState(id,newState,sequenceNumber)
          }
        }
        else if (type == "log"){
          $('#log').append(message+"\n");
          //allways scroll directly to bottom
          var textarea = document.getElementById('log');
          textarea.scrollTop = textarea.scrollHeight;
        }
        else if (type == "table_{{view.pcaId}}"){
          var stateTable = JSON.parse(message);
          for (var id in stateTable){
            var sequenceNumber = stateTable[id][0]
            var newState = stateTable[id][1]
            updateState(id,newState,sequenceNumber)
          }
        }
        else if (type == "bufferedLog_{{pcaId}}"){
          //empty log
          $('#log').html("")
          $('#log').append(message+"\n");
          //allways scroll directly to bottom
          var textarea = document.getElementById('log');
          textarea.scrollTop = textarea.scrollHeight;
        }
    };
}
createWebSocket()

returnCodeCases = {
  200: function(){
    $('#alertBox').css('visibility', 'hidden');
  },
  403: function(){
    console.log("fail");
    $('#alertBox').css('visibility', 'visible');
    $('#alertBox').html("<strong>Warning!</strong> Your permission timed out")
  },
};

function setactive(id){
  $.ajax({
      type: "POST",
      url: "{% url 'GUI:setActive' pcaId%}",
      data:{csrfmiddlewaretoken: '{{ csrf_token }}', "detectorId" : id},
      statusCode: returnCodeCases
  });
}

function setinactive(id){
  $.ajax({
      type: "POST",
      url: "{% url 'GUI:setInactive' pcaId%}",
      data:{csrfmiddlewaretoken: '{{ csrf_token }}', "detectorId" : id},
      statusCode: returnCodeCases
  });
}

$(document).ready(function() {
    $("#ready").click(function(e) {
        e.preventDefault();
        $.ajax({
            type: "POST",
            url: "{% url 'GUI:ready' pcaId%}",
            data:{csrfmiddlewaretoken: '{{ csrf_token }}'},
            /*"success": function(result) {
                console.log(result);
            },*/
            statusCode: returnCodeCases
        });
    });
    $("#start").click(function(e) {
        e.preventDefault();
        $.ajax({
            type: "POST",
            url: "{% url 'GUI:start' pcaId%}",
            data:{csrfmiddlewaretoken: '{{ csrf_token }}'},
            statusCode: returnCodeCases
        });
    });
    $("#stop").click(function(e) {
        e.preventDefault();
        $.ajax({
            type: "POST",
            url: "{% url 'GUI:stop' pcaId%}",
            data:{csrfmiddlewaretoken: '{{ csrf_token }}'},
            statusCode: returnCodeCases
        });
    });
    $("#shutdown").click(function(e) {
        e.preventDefault();
        $.ajax({
            type: "POST",
            url: "{% url 'GUI:shutdown' pcaId%}",
            data:{csrfmiddlewaretoken: '{{ csrf_token }}'},
            statusCode: returnCodeCases
        });
    });
});
</script>
<title>PCA{{view.pcaId}} Monitor</title>
</head>

<body id="page-top">

  <nav class="navbar navbar-expand navbar-dark bg-dark static-top">

    <a class="navbar-brand mr-1" href="{% url 'GUI:index'%}">Start ECS</a>

    <button class="btn btn-link btn-sm text-white order-1 order-sm-0" id="sidebarToggle" href="#">
      <i class="fas fa-bars"></i>
    </button>

    <ul class="navbar-nav ml-auto mr-0 mr-md-3 my-2 my-md-0">
      <li class="nav-item dropdown no-arrow">
        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="fas fa-user-circle fa-fw"></i>
        </a>
        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
          <h5 class="dropdown-header">Logged in as {{user}}</h5>
          {% if perms.GUI.can_take_control %}
            {% if view.userInControl and view.userInControl != "You" %}
              <h5 class="dropdown-header">Control already Taken by User : {{view.userInControl}}</h5>
            {% endif %}
            {% if "has_control" in pcaPerms %}
              <h5 class="dropdown-header">You are currently controlling the Partition</h5>
              <a class="dropdown-item" href="{% url 'GUI:giveup_control' pcaId%}">give up control of {{view.pcaObject}}</a>
            {% elif not view.userInControl %}
              <a class="dropdown-item" href="{% url 'GUI:take_control' pcaId%}">take control of {{view.pcaObject}}</a>
            {% endif %}
            <div class="dropdown-divider"></div>
          {% endif %}
          <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logoutModal">Logout</a>
        </div>
      </li>
    </ul>

  </nav>

  <div id="wrapper">

    <!-- Sidebar -->
    <ul class="sidebar navbar-nav">
      <li class="nav-item active">
        <a class="nav-link" href="{% url 'GUI:index' %}">
          <i class="fas fa-fw fa-tachometer-alt"></i>
          <span>Overview</span>
        </a>
      </li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="pcaDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="fas fa-fw fa-desktop"></i>
          <span>PCAs</span>
        </a>
        <div class="dropdown-menu" aria-labelledby="pcaDropdown">
          {% for pca in view.partitions %}
            <h6 class="dropdown-header">PCA <a href="{%url 'GUI:pca' pca%}">{{pca}}</a> </h6>
            <div class="dropdown-divider"></div>
          {%endfor%}
        </div>
      </li>
      {% if "has_control" in ecsPerms %}
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="detectorActDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="fas fa-fw fa-desktop"></i>
          <span>Detector Activities</span>
        </a>
        <div class="dropdown-menu" aria-labelledby="detectorActDropdown">
          <a class="dropdown-item" href="{% url 'GUI:create_detector' %}">Create Detector</a>
          <a class="dropdown-item" href="{% url 'GUI:delete_detectors' %}">Delete Detector</a>
          <a class="dropdown-item" href="{% url 'GUI:move_detectors' %}">Move Detector</a>
        </div>
      </li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="partitionActDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="fas fa-fw fa-desktop"></i>
          <span>Partition Activities</span>
        </a>
        <div class="dropdown-menu" aria-labelledby="partitionActDropdown">
          <a class="dropdown-item" href="{% url 'GUI:create_pca' %}">Create Partition</a>
          <a class="dropdown-item" href="{% url 'GUI:delete_pca' %}">Delete Partition</a>
        </div>
      </li>
      {%endif%}
    </ul>

    <div id="content-wrapper">

      <div class="container-fluid">

        <!-- Breadcrumbs-->
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="{% url 'GUI:index' %}">Overview</a>
          </li>
          <li class="breadcrumb-item active">PCA {{view.pcaId}} Monitor</li>
        </ol>
        <div class="alert alert-danger" id="alertBox" style="visibility: hidden">
        </div>
        <h1>PCA {{view.pcaId}} Monitor</h1>
        <div>
          <table class="table table-bordered" id="stateTable">
            <tr>
              <th>Detector</th>
              <th>Status</th>
            </tr>
          </table>
        </div>
        {% if "has_control" in pcaPerms %}
        <div>
          <button id="ready" class="btn btn-primary">ready</button>
          <button id="start" class="btn btn-primary">start</button>
          <button id="stop" class="btn btn-primary">stop</button>
          <button id="shutdown" class="btn btn-primary">shutdown</button>
        </div>
        {% endif %}
        <textarea class="form-control log" rows="10" readonly id="log"></textarea>
      </div>
  </div>

<!-- Sticky Footer
<footer class="sticky-footer">
  <div class="container my-auto">
    <div class="copyright text-center my-auto">
      <span>CBM ECS</span>
    </div>
  </div>
</footer>-->

</div>
<!-- /.content-wrapper -->

</div>
<!-- /#wrapper -->

<!-- Scroll to Top Button
<a class="scroll-to-top rounded" href="#page-top">
<i class="fas fa-angle-up"></i>
</a>-->

<!-- Logout Modal-->
{% if user.is_authenticated %}
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
<div class="modal-dialog" role="document">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="exampleModalLabel">{{ user.get_username }}, ready to Leave?</h5>
      <button class="close" type="button" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">×</span>
      </button>
    </div>
    <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
    <div class="modal-footer">
      <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
      <a class="btn btn-primary" href="{% url 'GUI:logout'%}?next={{request.path}}">Logout</a>
    </div>
  </div>
</div>
</div>
{% else %}
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
<div class="modal-dialog" role="document">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="exampleModalLabel">Login?</h5>
      <button class="close" type="button" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">×</span>
      </button>
    </div>
    <div class="modal-body">Select "Login" below if you are ready to login.</div>
    <div class="modal-footer">
      <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
      <a class="btn btn-primary" href="{% url 'GUI:login'%}?next={{request.path}}">Login</a>
    </div>
  </div>
</div>
</div>
{% endif %}
{%endblock%}


<!-- Bootstrap core JavaScript-->
<script src="{% static 'GUI/vendor/jquery/jquery.min.js' %}"></script>
<script src="{% static 'GUI/vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>

<!-- Core plugin JavaScript-->
<script src="{% static 'GUI/vendor/jquery-easing/jquery.easing.min.js' %}"></script>

<!-- Custom scripts for all pages-->
<script src="{% static 'GUI/scripts/sb-admin.js' %}"></script>

</body>
</html>
